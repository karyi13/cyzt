<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨æ ‡çš„ç­›é€‰ä¸åˆ†æå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .subtitle {
            font-size: 16px;
            opacity: 0.95;
        }

        .status-bar {
            background-color: #f8f9fa;
            padding: 15px 40px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-dot.loading {
            background-color: #ffc107;
        }

        .status-dot.error {
            background-color: #dc3545;
        }

        .content-wrapper {
            padding: 40px;
        }

        .filter-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .filter-section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-item label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        input[type="number"],
        select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background-color: white;
        }

        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .stats-section {
            margin-bottom: 30px;
        }

        .stats-section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .rank-stats-section {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .rank-stats-section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .results-section {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            overflow-x: auto;
        }

        .results-section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        .sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s;
        }

        .sortable:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sort-icon {
            margin-left: 5px;
            font-size: 12px;
        }

        .profit {
            color: #e74c3c;
            font-weight: bold;
        }

        .loss {
            color: #27ae60;
            font-weight: bold;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #dc3545;
        }

        /* æ¨¡æ€çª—å£æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            overflow: auto;
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 1100px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
        }

        .close {
            color: #aaa;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
            line-height: 1;
        }

        .close:hover,
        .close:focus {
            color: #333;
        }

        #klineChart {
            width: 100%;
            height: 500px;
            margin-top: 20px;
        }

        .kline-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .kline-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .no-data-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .content-wrapper {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; align-items: center; justify-content: space-between; max-width: 1400px; margin: 0 auto;">
                <button onclick="window.location.href='/'" style="background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'; this.style.transform='translateY(0)'">
                    <span style="font-size: 18px;">â†</span> è¿”å›é¦–é¡µ
                </button>
                <div style="text-align: center; flex: 1;">
                    <h1>ğŸ“Š è‚¡ç¥¨æ ‡çš„ç­›é€‰ä¸åˆ†æå·¥å…·</h1>
                    <p class="subtitle">åŸºäºæ¶¨åœåè¡¨ç°çš„æ™ºèƒ½ç­›é€‰ä¸ä»“ä½å»ºè®®ç³»ç»Ÿ</p>
                </div>
                <div style="width: 100px;"></div>
            </div>
        </header>

        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">æ­£åœ¨åŠ è½½æ•°æ®...</span>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                <button class="secondary" onclick="document.getElementById('csvFileInput').click()" style="padding: 8px 16px; font-size: 14px;">ğŸ“ æ‰‹åŠ¨ä¸Šä¼ CSV</button>
                <div id="dataInfo">æ•°æ®è®°å½•: <strong id="totalRecords">0</strong> æ¡</div>
            </div>
        </div>

        <div class="content-wrapper">
            <!-- ç­›é€‰æ¡ä»¶ -->
            <div class="filter-section">
                <h2>ğŸ” ç­›é€‰æ¡ä»¶</h2>
                <div class="filter-grid">
                    <div class="filter-item">
                        <label for="totalValue">æ€»æ•° (æ¶¨åœè‚¡ç¥¨æ€»æ•°):</label>
                        <input type="number" id="totalValue" min="0" placeholder="è¾“å…¥æ€»æ•°">
                    </div>
                    <div class="filter-item">
                        <label for="rankMin">æ’åæœ€å°å€¼:</label>
                        <input type="number" id="rankMin" min="1" value="1">
                    </div>
                    <div class="filter-item">
                        <label for="rankMax">æ’åæœ€å¤§å€¼:</label>
                        <input type="number" id="rankMax" min="1" value="20">
                    </div>
                    <div class="filter-item">
                        <label for="timeRange">æ—¶é—´èŒƒå›´:</label>
                        <select id="timeRange">
                            <option value="all">å…¨éƒ¨æ—¶é—´</option>
                            <option value="1">æœ€è¿‘1ä¸ªæœˆ</option>
                            <option value="3">æœ€è¿‘3ä¸ªæœˆ</option>
                            <option value="6">æœ€è¿‘6ä¸ªæœˆ</option>
                            <option value="12">æœ€è¿‘12ä¸ªæœˆ</option>
                        </select>
                    </div>
                </div>
                <div class="button-group">
                    <button id="filterBtn">ğŸ” åº”ç”¨ç­›é€‰</button>
                    <button class="secondary" id="resetBtn">ğŸ”„ é‡ç½®æ¡ä»¶</button>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats-section" id="statsSection" style="display: none;">
                <h2>ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">ç­›é€‰ç»“æœæ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgProfitRate">0.00%</div>
                        <div class="stat-label">å¹³å‡ç›ˆäºæ¯”ä¾‹</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="winRate">0.00%</div>
                        <div class="stat-label">èƒœç‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="profitCount">0</div>
                        <div class="stat-label">ç›ˆåˆ©è‚¡ç¥¨æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="lossCount">0</div>
                        <div class="stat-label">äºæŸè‚¡ç¥¨æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalProfit">0.00</div>
                        <div class="stat-label">æ€»ç›ˆäºé‡‘é¢</div>
                    </div>
                </div>
            </div>

            <!-- å„æ’åç»Ÿè®¡ -->
            <div class="rank-stats-section" id="rankStatsSection" style="display: none;">
                <h2>ğŸ“Š å„æ’åç»Ÿè®¡ä¿¡æ¯</h2>
                <div style="overflow-x: auto;">
                    <table id="rankStatsTable">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>å¹³å‡ç›ˆäºæ¯”ä¾‹</th>
                                <th>èƒœç‡</th>
                                <th>äº¤æ˜“æ€»æ•°</th>
                                <th>ç›ˆåˆ©æ•°</th>
                                <th>äºæŸæ•°</th>
                            </tr>
                        </thead>
                        <tbody id="rankStatsBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ç­›é€‰ç»“æœ -->
            <div class="results-section">
                <h2>ğŸ“‹ ç­›é€‰ç»“æœ</h2>
                <div id="loading" class="loading-spinner">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨åŠ è½½æ•°æ®...</div>
                </div>
                <div id="noData" class="no-data" style="display: none;">
                    <div class="no-data-icon">ğŸ“­</div>
                    <h3>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„è®°å½•</h3>
                    <p>è¯·è°ƒæ•´ç­›é€‰æ¡ä»¶åé‡è¯•</p>
                </div>
                <table id="resultsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th class="sortable" data-column="æ¶¨åœæ—¥æœŸ">æ¶¨åœæ—¥æœŸ <span class="sort-icon">â†“</span></th>
                            <th>è‚¡ç¥¨ä»£ç </th>
                            <th>ä¹°å…¥ä»·</th>
                            <th>å–å‡ºä»·</th>
                            <th>ç›ˆäº</th>
                            <th class="sortable" data-column="ç›ˆäºæ¯”ä¾‹">ç›ˆäºæ¯”ä¾‹ <span class="sort-icon"></span></th>
                            <th class="sortable" data-column="ä¹°å…¥æ—¥æœŸå¼€ç›˜æ¶¨è·Œå¹…">ä¹°å…¥æ—¥å¼€ç›˜æ¶¨è·Œå¹… <span class="sort-icon"></span></th>
                            <th>æ€»æ•°</th>
                            <th>æ’å</th>
                            <th>ä»“ä½å»ºè®®</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Kçº¿å›¾æ¨¡æ€çª—å£ -->
    <div id="klineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="klineTitle">Kçº¿å›¾</h2>
                <span class="close">&times;</span>
            </div>
            <div id="klineChart"></div>
        </div>
    </div>

    <script>
        let allData = [];
        let currentSortColumn = 'æ¶¨åœæ—¥æœŸ';
        let currentSortOrder = 'desc';

        // é»˜è®¤åŠ è½½çš„CSVæ–‡ä»¶å
        const DEFAULT_CSV_FILE = 'trade_with_cangwei.csv';

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¯»å–é»˜è®¤CSVæ–‡ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥è®¿é—®åè®®
            if (window.location.protocol === 'file:') {
                const statusBar = document.querySelector('.status-bar');
                const warning = document.createElement('div');
                warning.style.cssText = 'background: #fff3cd; color: #856404; padding: 10px; margin: 10px 40px; border-radius: 8px; border-left: 4px solid #ffc107;';
                warning.innerHTML = '<strong>âš ï¸ è­¦å‘Š:</strong> æ‚¨æ­£åœ¨ä½¿ç”¨ file:// åè®®è®¿é—®æ­¤é¡µé¢ã€‚Kçº¿å›¾åŠŸèƒ½å°†æ— æ³•ä½¿ç”¨ã€‚è¯·é€šè¿‡ HTTP æœåŠ¡å™¨è®¿é—®: <strong>http://localhost:8000/stock_analysis_enhanced_v2.html</strong>';
                statusBar.parentNode.insertBefore(warning, statusBar.nextSibling);
            }
            
            console.log('é¡µé¢åè®®:', window.location.protocol);
            console.log('é¡µé¢URL:', window.location.href);
            
            loadDefaultCSVFile();
            setupEventListeners();
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ–‡ä»¶ä¸Šä¼ 
            document.getElementById('csvFileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    updateStatus('loading', 'æ­£åœ¨è¯»å–æ–‡ä»¶...');
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        parseCSV(event.target.result);
                        updateStatus('', 'æ–‡ä»¶åŠ è½½æˆåŠŸ');
                        document.getElementById('totalRecords').textContent = allData.length;
                        applyFilters();
                    };
                    reader.onerror = function() {
                        updateStatus('error', 'æ–‡ä»¶è¯»å–å¤±è´¥');
                    };
                    reader.readAsText(file, 'utf-8');
                }
            });

            // æ’åèŒƒå›´è”åŠ¨
            const rankMinInput = document.getElementById('rankMin');
            const rankMaxInput = document.getElementById('rankMax');

            rankMinInput.addEventListener('input', function() {
                const minVal = parseInt(rankMinInput.value);
                if (!isNaN(minVal)) {
                    rankMaxInput.value = minVal;
                    applyFilters();
                }
            });

            rankMaxInput.addEventListener('input', function() {
                applyFilters();
            });

            // å®æ—¶ç­›é€‰
            document.getElementById('totalValue').addEventListener('input', applyFilters);
            document.getElementById('timeRange').addEventListener('change', applyFilters);

            // ç­›é€‰æŒ‰é’®
            document.getElementById('filterBtn').addEventListener('click', applyFilters);

            // é‡ç½®æŒ‰é’®
            document.getElementById('resetBtn').addEventListener('click', function() {
                document.getElementById('totalValue').value = '';
                document.getElementById('rankMin').value = '1';
                document.getElementById('rankMax').value = '20';
                document.getElementById('timeRange').value = 'all';
                applyFilters();
            });

            // æ’åºåŠŸèƒ½
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.dataset.column;
                    if (currentSortColumn === column) {
                        currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSortColumn = column;
                        currentSortOrder = 'desc';
                    }
                    updateSortIcons();
                    applyFilters();
                });
            });

            // æ¨¡æ€çª—å£å…³é—­
            document.querySelector('.close').addEventListener('click', closeKlineModal);
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('klineModal');
                if (event.target == modal) {
                    closeKlineModal();
                }
            });
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeKlineModal();
                }
            });
        }

        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatus(status, text) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = 'status-dot ' + status;
            statusText.textContent = text;
        }

        // è¯»å–é»˜è®¤CSVæ–‡ä»¶
        function loadDefaultCSVFile() {
            updateStatus('loading', 'æ­£åœ¨åŠ è½½æ•°æ®...');
            
            fetch(DEFAULT_CSV_FILE)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('æ–‡ä»¶åŠ è½½å¤±è´¥: ' + response.statusText);
                    }
                    return response.text();
                })
                .then(csvText => {
                    parseCSV(csvText);
                    updateStatus('', 'æ•°æ®åŠ è½½æˆåŠŸ');
                    document.getElementById('totalRecords').textContent = allData.length;
                    applyFilters();
                })
                .catch(error => {
                    updateStatus('error', 'æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
                    document.getElementById('loading').innerHTML = `
                        <div class="error-message">
                            <strong>é”™è¯¯:</strong> ${error.message}<br>
                            è¯·ç¡®ä¿ <strong>${DEFAULT_CSV_FILE}</strong> æ–‡ä»¶å­˜åœ¨äºåŒä¸€ç›®å½•ä¸‹ã€‚
                        </div>
                    `;
                });
        }

        // è§£æCSVæ•°æ®
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());

            allData = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;

                const values = parseCSVLine(lines[i]);
                if (values.length !== headers.length) continue;

                const row = {};
                for (let j = 0; j < headers.length; j++) {
                    row[headers[j]] = values[j];
                }

                // è½¬æ¢æ•°æ®ç±»å‹
                row['æ€»æ•°'] = parseInt(row['æ€»æ•°']) || 0;
                row['æ’å'] = parseInt(row['æ’å']) || 0;
                row['ç›ˆäº'] = parseFloat(row['ç›ˆäº']) || 0;
                row['ç›ˆäºæ¯”ä¾‹'] = parseFloat(row['ç›ˆäºæ¯”ä¾‹']) || 0;
                row['ä¹°å…¥ä»·'] = parseFloat(row['ä¹°å…¥ä»·']) || 0;
                row['å–å‡ºä»·'] = parseFloat(row['å–å‡ºä»·']) || 0;
                row['ä¹°å…¥æ—¥æœŸå¼€ç›˜æ¶¨è·Œå¹…'] = parseFloat(row['ä¹°å…¥æ—¥æœŸå¼€ç›˜æ¶¨è·Œå¹…']) || 0;
                row['ä¹°å…¥æ—¥æœŸæ”¶ç›˜æ¶¨è·Œå¹…'] = parseFloat(row['ä¹°å…¥æ—¥æœŸæ”¶ç›˜æ¶¨è·Œå¹…']) || 0;
                row['å–å‡ºæ—¥æœŸå¼€ç›˜æ¶¨è·Œå¹…'] = parseFloat(row['å–å‡ºæ—¥æœŸå¼€ç›˜æ¶¨è·Œå¹…']) || 0;
                row['å–å‡ºæ—¥æœŸæ”¶ç›˜æ¶¨è·Œå¹…'] = parseFloat(row['å–å‡ºæ—¥æœŸæ”¶ç›˜æ¶¨è·Œå¹…']) || 0;
                row['èƒœç‡'] = parseFloat(row['èƒœç‡']) || 0;
                row['ä»“ä½'] = parseFloat(row['ä»“ä½']) || 0;

                allData.push(row);
            }
        }

        // è§£æCSVè¡Œ
        function parseCSVLine(line) {
            const values = [];
            let currentValue = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(currentValue.trim());
                    currentValue = '';
                } else {
                    currentValue += char;
                }
            }
            values.push(currentValue.trim());
            return values;
        }

        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            if (allData.length === 0) return;

            const totalValue = parseInt(document.getElementById('totalValue').value);
            const rankMin = parseInt(document.getElementById('rankMin').value) || 1;
            const rankMax = parseInt(document.getElementById('rankMax').value) || 20;
            const timeRange = document.getElementById('timeRange').value;

            // æ—¶é—´èŒƒå›´
            let startDate = null;
            if (timeRange !== 'all') {
                const months = parseInt(timeRange);
                startDate = new Date();
                startDate.setMonth(startDate.getMonth() - months);
            }

            // ç­›é€‰æ•°æ®
            const filteredData = allData.filter(row => {
                const totalMatch = isNaN(totalValue) ? true : row['æ€»æ•°'] === totalValue;
                const rankMatch = row['æ’å'] >= rankMin && row['æ’å'] <= rankMax;
                const timeMatch = !startDate || new Date(row['æ¶¨åœæ—¥æœŸ']) >= startDate;
                return totalMatch && rankMatch && timeMatch;
            });

            // è®¡ç®—ç»Ÿè®¡
            calculateStats(filteredData);

            // å„æ’åç»Ÿè®¡
            const totalFilteredData = allData.filter(row => {
                const totalMatch = isNaN(totalValue) ? true : row['æ€»æ•°'] === totalValue;
                const timeMatch = !startDate || new Date(row['æ¶¨åœæ—¥æœŸ']) >= startDate;
                return totalMatch && timeMatch;
            });
            calculateRankStats(totalFilteredData, totalValue);

            // æ˜¾ç¤ºç»“æœ
            displayResults(filteredData);
        }

        // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
        function calculateStats(data) {
            if (data.length === 0) {
                document.getElementById('statsSection').style.display = 'none';
                return;
            }

            const totalProfit = data.reduce((sum, row) => sum + row['ç›ˆäº'], 0);
            const avgProfitRate = data.reduce((sum, row) => sum + row['ç›ˆäºæ¯”ä¾‹'], 0) / data.length;
            const profitCount = data.filter(row => row['ç›ˆäº'] > 0).length;
            const lossCount = data.filter(row => row['ç›ˆäº'] < 0).length;
            const winRate = (profitCount / data.length) * 100;

            document.getElementById('totalCount').textContent = data.length;
            document.getElementById('avgProfitRate').textContent = avgProfitRate.toFixed(2) + '%';
            document.getElementById('profitCount').textContent = profitCount;
            document.getElementById('lossCount').textContent = lossCount;
            document.getElementById('winRate').textContent = winRate.toFixed(2) + '%';
            document.getElementById('totalProfit').textContent = totalProfit.toFixed(2);

            document.getElementById('statsSection').style.display = 'block';
        }

        // è®¡ç®—å„æ’åç»Ÿè®¡
        function calculateRankStats(data, totalValue) {
            if (isNaN(totalValue) || totalValue <= 0) {
                document.getElementById('rankStatsSection').style.display = 'none';
                return;
            }

            const rankStats = {};
            for (let i = 1; i <= totalValue; i++) {
                rankStats[i] = {
                    totalProfitRate: 0,
                    profitCount: 0,
                    lossCount: 0,
                    totalTrades: 0
                };
            }

            data.forEach(row => {
                const rank = row['æ’å'];
                if (rank >= 1 && rank <= totalValue && rankStats[rank]) {
                    rankStats[rank].totalProfitRate += row['ç›ˆäºæ¯”ä¾‹'];
                    rankStats[rank].totalTrades++;
                    if (row['ç›ˆäº'] > 0) {
                        rankStats[rank].profitCount++;
                    } else if (row['ç›ˆäº'] < 0) {
                        rankStats[rank].lossCount++;
                    }
                }
            });

            const tbody = document.getElementById('rankStatsBody');
            tbody.innerHTML = '';

            for (let i = 1; i <= totalValue; i++) {
                const stats = rankStats[i];
                const avgProfitRate = stats.totalTrades > 0 ? (stats.totalProfitRate / stats.totalTrades) : 0;
                const winRate = stats.totalTrades > 0 ? (stats.profitCount / stats.totalTrades) * 100 : 0;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${i}</strong></td>
                    <td class="${avgProfitRate >= 0 ? 'profit' : 'loss'}">${avgProfitRate.toFixed(2)}%</td>
                    <td>${winRate.toFixed(2)}%</td>
                    <td>${stats.totalTrades}</td>
                    <td>${stats.profitCount}</td>
                    <td>${stats.lossCount}</td>
                `;
                tbody.appendChild(tr);
            }

            document.getElementById('rankStatsSection').style.display = 'block';
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(data) {
            const loading = document.getElementById('loading');
            const noData = document.getElementById('noData');
            const table = document.getElementById('resultsTable');
            const tbody = document.getElementById('resultsBody');

            loading.style.display = 'none';
            
            if (data.length === 0) {
                noData.style.display = 'block';
                table.style.display = 'none';
                return;
            }

            noData.style.display = 'none';
            table.style.display = 'table';

            // æ’åº
            data.sort((a, b) => {
                let valueA, valueB;
                if (currentSortColumn === 'æ¶¨åœæ—¥æœŸ') {
                    valueA = new Date(a[currentSortColumn]);
                    valueB = new Date(b[currentSortColumn]);
                } else {
                    valueA = parseFloat(a[currentSortColumn]);
                    valueB = parseFloat(b[currentSortColumn]);
                }
                return currentSortOrder === 'asc' ? valueA - valueB : valueB - valueA;
            });

            updateSortIcons();

            tbody.innerHTML = '';
            data.forEach(row => {
                const profitClass = row['ç›ˆäº'] >= 0 ? 'profit' : 'loss';
                const positionPercent = (row['ä»“ä½'] * 100).toFixed(1);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row['æ¶¨åœæ—¥æœŸ']}</td>
                    <td><strong>${row['è‚¡ç¥¨ä»£ç ']}</strong></td>
                    <td>${row['ä¹°å…¥ä»·'].toFixed(2)}</td>
                    <td>${row['å–å‡ºä»·'].toFixed(2)}</td>
                    <td class="${profitClass}">${row['ç›ˆäº'].toFixed(2)}</td>
                    <td class="${profitClass}"><strong>${row['ç›ˆäºæ¯”ä¾‹'].toFixed(2)}%</strong></td>
                    <td>${row['ä¹°å…¥æ—¥æœŸå¼€ç›˜æ¶¨è·Œå¹…'].toFixed(2)}%</td>
                    <td>${row['æ€»æ•°']}</td>
                    <td><strong>${row['æ’å']}</strong></td>
                    <td><strong>${positionPercent}%</strong></td>
                    <td><button class="kline-btn" onclick="showKline('${row['æ¶¨åœæ—¥æœŸ']}', '${row['è‚¡ç¥¨ä»£ç ']}')">ğŸ“ˆ Kçº¿</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // æ›´æ–°æ’åºå›¾æ ‡
        function updateSortIcons() {
            document.querySelectorAll('.sortable').forEach(header => {
                const column = header.dataset.column;
                const sortIcon = header.querySelector('.sort-icon');
                if (currentSortColumn === column) {
                    sortIcon.textContent = currentSortOrder === 'asc' ? 'â†‘' : 'â†“';
                } else {
                    sortIcon.textContent = '';
                }
            });
        }

        // æ˜¾ç¤ºKçº¿å›¾
        function showKline(date, stockCode) {
            document.getElementById('klineTitle').textContent = `${stockCode} - ${date} Kçº¿å›¾`;
            document.getElementById('klineModal').style.display = 'block';
            
            const filePath = `data/kline_cache/${date}_${stockCode}.SZ.csv`;
            loadAndDrawKline(filePath, stockCode, date);
        }

        // å…³é—­Kçº¿å›¾
        function closeKlineModal() {
            document.getElementById('klineModal').style.display = 'none';
        }

        // åŠ è½½å¹¶ç»˜åˆ¶Kçº¿å›¾
        function loadAndDrawKline(filePath, stockCode, date) {
            const chartContainer = document.getElementById('klineChart');
            chartContainer.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><div>æ­£åœ¨åŠ è½½Kçº¿æ•°æ®...</div></div>';

            // ä½¿ç”¨XMLHttpRequestæ›¿ä»£fetchï¼Œå…¼å®¹æ€§æ›´å¥½
            const xhr = new XMLHttpRequest();
            const fullUrl = new URL(filePath, window.location.href).href;
            
            console.log('æ­£åœ¨åŠ è½½Kçº¿æ•°æ®:', fullUrl);
            console.log('å½“å‰é¡µé¢URL:', window.location.href);
            
            xhr.open('GET', fullUrl, true);
            xhr.onreadystatechange = function() {
                console.log('XHRçŠ¶æ€:', xhr.readyState, 'HTTPçŠ¶æ€:', xhr.status);
                
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            const klineData = parseKlineCSV(xhr.responseText);
                            if (klineData.length === 0) {
                                throw new Error('Kçº¿æ•°æ®ä¸ºç©º');
                            }
                            console.log('æˆåŠŸåŠ è½½Kçº¿æ•°æ®ï¼Œå…± ' + klineData.length + ' æ¡è®°å½•');
                            drawKlineChart(klineData, stockCode, date);
                        } catch (error) {
                            console.error('è§£æKçº¿æ•°æ®å¤±è´¥:', error);
                            showKlineError(filePath, fullUrl, 'è§£æCSVå¤±è´¥: ' + error.message);
                        }
                    } else {
                        console.error('HTTPè¯·æ±‚å¤±è´¥:', xhr.status, xhr.statusText);
                        showKlineError(filePath, fullUrl, `HTTP ${xhr.status}: ${xhr.statusText || 'è¯·æ±‚å¤±è´¥'}`);
                    }
                }
            };
            
            xhr.onerror = function() {
                console.error('XHRé”™è¯¯äº‹ä»¶è§¦å‘');
                showKlineError(filePath, fullUrl, 'ç½‘ç»œé”™è¯¯æˆ–æ–‡ä»¶ä¸å­˜åœ¨');
            };
            
            xhr.send();
        }

        // æ˜¾ç¤ºKçº¿åŠ è½½é”™è¯¯
        function showKlineError(filePath, fullUrl, errorMsg) {
            const chartContainer = document.getElementById('klineChart');
            chartContainer.innerHTML = `
                <div class="error-message">
                    <strong>âš ï¸ Kçº¿æ•°æ®åŠ è½½å¤±è´¥</strong><br><br>
                    <strong>é”™è¯¯ä¿¡æ¯:</strong> ${errorMsg}<br><br>
                    <strong>æ–‡ä»¶è·¯å¾„:</strong> <code>${filePath}</code><br><br>
                    <strong>å®Œæ•´URL:</strong> <code>${fullUrl}</code><br><br>
                    <strong>è§£å†³æ–¹æ¡ˆ:</strong><br>
                    1. è¯·ç¡®ä¿é€šè¿‡ HTTP æœåŠ¡å™¨è®¿é—®é¡µé¢ (<strong>http://localhost:8000</strong>)<br>
                    2. ä¸è¦ä½¿ç”¨ file:// åè®®ç›´æ¥æ‰“å¼€HTMLæ–‡ä»¶<br>
                    3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°(F12)æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯<br><br>
                    <button class="kline-btn" onclick="window.open('${fullUrl}', '_blank')">ğŸ“¥ å°è¯•åœ¨æ–°çª—å£æ‰“å¼€CSVæ–‡ä»¶</button>
                    <button class="kline-btn" onclick="location.reload()">ğŸ”„ åˆ·æ–°é¡µé¢é‡è¯•</button>
                </div>
            `;
        }

        // è§£æKçº¿CSV
        function parseKlineCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length < 2) {
                console.error('CSVæ•°æ®è¡Œæ•°ä¸è¶³');
                return [];
            }
            
            const headers = lines[0].split(',').map(h => h.trim());
            console.log('CSVåˆ—å:', headers);
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = parseCSVLine(lines[i]);
                if (values.length !== headers.length) {
                    console.warn('ç¬¬' + i + 'è¡Œåˆ—æ•°ä¸åŒ¹é…ï¼Œè·³è¿‡');
                    continue;
                }

                const row = {};
                headers.forEach((header, j) => {
                    row[header] = values[j].trim();
                });

                // è½¬æ¢æ•°å€¼ç±»å‹
                row['å¼€ç›˜'] = parseFloat(row['å¼€ç›˜']);
                row['æ”¶ç›˜'] = parseFloat(row['æ”¶ç›˜']);
                row['æœ€é«˜'] = parseFloat(row['æœ€é«˜']);
                row['æœ€ä½'] = parseFloat(row['æœ€ä½']);

                if (!isNaN(row['å¼€ç›˜']) && !isNaN(row['æ”¶ç›˜']) && !isNaN(row['æœ€é«˜']) && !isNaN(row['æœ€ä½'])) {
                    data.push(row);
                } else {
                    console.warn('ç¬¬' + i + 'è¡Œæ•°æ®æ— æ•ˆ:', row);
                }
            }
            
            console.log('æˆåŠŸè§£æKçº¿æ•°æ®:', data.length + 'æ¡');
            return data;
        }

        // ç»˜åˆ¶Kçº¿å›¾
        function drawKlineChart(data, stockCode, limitUpDate) {
            const chartContainer = document.getElementById('klineChart');
            chartContainer.innerHTML = '';

            const canvas = document.createElement('canvas');
            chartContainer.appendChild(canvas);

            setTimeout(() => {
                const width = chartContainer.clientWidth || 1000;
                const height = 500;
                canvas.width = width;
                canvas.height = height;

                const ctx = canvas.getContext('2d');
                const margin = { top: 40, right: 60, bottom: 80, left: 70 };
                const chartWidth = width - margin.left - margin.right;
                const chartHeight = height - margin.top - margin.bottom;

                // æ‰¾åˆ°æ¶¨åœæ—¥æœŸçš„ç´¢å¼•
                const limitUpIndex = data.findIndex(d => d['æ—¥æœŸ'] === limitUpDate);
                console.log('æ¶¨åœæ—¥æœŸ:', limitUpDate, 'ç´¢å¼•:', limitUpIndex);

                // ä»·æ ¼èŒƒå›´
                let maxPrice = Math.max(...data.map(d => d['æœ€é«˜']));
                let minPrice = Math.min(...data.map(d => d['æœ€ä½']));
                const priceRange = maxPrice - minPrice;
                maxPrice += priceRange * 0.1;
                minPrice -= priceRange * 0.1;

                // èƒŒæ™¯
                ctx.fillStyle = '#f8f9fa';
                ctx.fillRect(0, 0, width, height);
                ctx.fillStyle = 'white';
                ctx.fillRect(margin.left, margin.top, chartWidth, chartHeight);

                // ç½‘æ ¼çº¿å’Œä»·æ ¼æ ‡ç­¾
                ctx.strokeStyle = '#e9ecef';
                ctx.lineWidth = 1;

                const priceLines = 5;
                for (let i = 0; i <= priceLines; i++) {
                    const y = margin.top + (chartHeight / priceLines) * i;
                    ctx.beginPath();
                    ctx.moveTo(margin.left, y);
                    ctx.lineTo(margin.left + chartWidth, y);
                    ctx.stroke();

                    const price = maxPrice - (priceRange * 1.2 / priceLines) * i;
                    ctx.fillStyle = '#666';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'right';
                    ctx.fillText(price.toFixed(2), margin.left - 10, y + 4);
                }

                // è®¡ç®—Kçº¿å®½åº¦å’Œé—´è·
                const candleWidth = Math.max(3, Math.min(15, chartWidth / data.length * 0.7));
                const candleGap = chartWidth / data.length * 0.3;

                // ç»˜åˆ¶Kçº¿
                data.forEach((candle, idx) => {
                    const x = margin.left + idx * (candleWidth + candleGap) + candleGap / 2;

                    const openY = margin.top + chartHeight - ((candle['å¼€ç›˜'] - minPrice) / (maxPrice - minPrice)) * chartHeight;
                    const closeY = margin.top + chartHeight - ((candle['æ”¶ç›˜'] - minPrice) / (maxPrice - minPrice)) * chartHeight;
                    const highY = margin.top + chartHeight - ((candle['æœ€é«˜'] - minPrice) / (maxPrice - minPrice)) * chartHeight;
                    const lowY = margin.top + chartHeight - ((candle['æœ€ä½'] - minPrice) / (maxPrice - minPrice)) * chartHeight;

                    const isUp = candle['æ”¶ç›˜'] >= candle['å¼€ç›˜'];
                    let color = isUp ? '#e74c3c' : '#27ae60';
                    
                    // æ¶¨åœæ—¥æœŸç‰¹æ®Šæ ‡è®°
                    if (idx === limitUpIndex) {
                        color = '#ff6b00'; // æ©™è‰²æ ‡è®°æ¶¨åœæ—¥
                        ctx.fillStyle = 'rgba(255, 107, 0, 0.1)';
                        ctx.fillRect(x - candleGap/2, margin.top, candleWidth + candleGap, chartHeight);
                    }

                    // ç»˜åˆ¶å®ä½“
                    ctx.fillStyle = color;
                    const bodyHeight = Math.abs(closeY - openY);
                    const bodyY = Math.min(openY, closeY);
                    ctx.fillRect(x, bodyY, candleWidth, Math.max(bodyHeight, 1));

                    // ç»˜åˆ¶å½±çº¿
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 1.5;
                    ctx.beginPath();
                    ctx.moveTo(x + candleWidth / 2, highY);
                    ctx.lineTo(x + candleWidth / 2, lowY);
                    ctx.stroke();
                });

                // æ ‡é¢˜
                ctx.fillStyle = '#2c3e50';
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${stockCode} Kçº¿å›¾`, width / 2, 25);

                // æ¶¨åœæ—¥æœŸæ ‡æ³¨
                if (limitUpIndex >= 0) {
                    ctx.fillStyle = '#ff6b00';
                    ctx.font = 'bold 14px Arial';
                    ctx.fillText(`æ¶¨åœæ—¥æœŸ: ${limitUpDate}`, width / 2 + 200, 25);
                }

                // æ—¥æœŸæ ‡ç­¾ï¼ˆä¼˜åŒ–æ˜¾ç¤ºï¼‰
                ctx.fillStyle = '#666';
                ctx.font = '11px Arial';
                ctx.textAlign = 'center';
                
                const dateStep = Math.max(1, Math.ceil(data.length / 12));
                for (let i = 0; i < data.length; i += dateStep) {
                    const x = margin.left + i * (candleWidth + candleGap) + candleGap / 2;
                    const dateStr = data[i]['æ—¥æœŸ'] ? data[i]['æ—¥æœŸ'].substring(5) : '';
                    ctx.save();
                    ctx.translate(x, height - 45);
                    ctx.rotate(-Math.PI / 6);
                    ctx.fillText(dateStr, 0, 0);
                    ctx.restore();
                }

                // è½´æ ‡ç­¾
                ctx.fillStyle = '#333';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æ—¥æœŸ', width / 2, height - 5);
                
                ctx.save();
                ctx.translate(20, height / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.fillText('ä»·æ ¼ (å…ƒ)', 0, 0);
                ctx.restore();

                // å›¾ä¾‹
                ctx.textAlign = 'left';
                ctx.font = '12px Arial';
                const legendX = margin.left + 10;
                const legendY = margin.top + 10;
                
                ctx.fillStyle = '#e74c3c';
                ctx.fillRect(legendX, legendY, 15, 10);
                ctx.fillStyle = '#333';
                ctx.fillText('ä¸Šæ¶¨', legendX + 20, legendY + 9);
                
                ctx.fillStyle = '#27ae60';
                ctx.fillRect(legendX + 60, legendY, 15, 10);
                ctx.fillStyle = '#333';
                ctx.fillText('ä¸‹è·Œ', legendX + 80, legendY + 9);
                
                ctx.fillStyle = '#ff6b00';
                ctx.fillRect(legendX + 120, legendY, 15, 10);
                ctx.fillStyle = '#333';
                ctx.fillText('æ¶¨åœæ—¥', legendX + 140, legendY + 9);

            }, 100);
        }
    </script>
</body>
</html>
